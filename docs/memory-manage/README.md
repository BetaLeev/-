# 内存管理
当操作系统接收道运行某程序道命令后，要为该程序的运行分配内存资源，创建进程，并把进程的全部或部分调入内存。

进程运行结束，系统要回收被撤销进程的内存空间。

内存管理的目标一方面是实现内存分配、内存回收等基本内存管理功能，另一方面是要提高内存空间的利用率和内存的访问速度。

每个程序员都希望自己都程序能运行在一个独占的、容量充分大、访问速度足够快的存储器上。然而，事实上计算机的内存是有限的，而且是被许多应用程序共享的。

处于同一内存中的不同进程之间必然会存在竞争与相互影响。操作系统的内存管理正是解决这一问题的，其目标是充分利用现有的内存资源，为应用程序提供方便的内存使用方式和一个快速、安全且充分大的存储器。


##  存储器的层次结构
内存是计算机存储系统的一部分。
存储器系统是一个具有不同容量、成本和访问时间的存储设备的层次结构。

CPU寄存器保存最常用的数据。靠近CPU的容量小、速度快的高速缓存存储器作为速度相对较慢、容量较大的主存中数据和指令子集的缓冲区。主存暂时存放容量更大、速度更慢的磁盘上的数据。而这些磁盘常常又作为存储在通过网络链接的其他及其的磁盘或磁带上的数据的缓冲区。

如果程序需要的数据是存放在CPU寄存器中的，程序执行期间在零个周期内就可以访问道它们。如果存储在高速缓存中，需要1-10个周期，如果这些数据存放在主存中，访问它们需要50-100个周期。而如果这些数据是存放在磁盘中的，要访问它们需要大约2000万个周期。

程序的执行遵循局部性原理。程序执行的局部性原理指出，程序在执行时呈现出局部性规律，即在一段较短的时间内，程序的执行仅局限于某个部分，相应地，它所访问的存储空间也局限于某个区域。

关于程序执行的局部性原理有以下几个论点。

1. 程序在执行时，除了少部分的转移和过程调用指令以外，在大多数情况下是顺序执行的。

2. 过程调用将会使程序的执行轨迹由一部分内存区域转移道另一部分内存区域。但研究表明，在大多数情况下，过程调用的深度都不超过5.

3. 程序中存在很多循环结构，它们虽然由少数指令构成，但多次执行。

4. 程序中往往包括许多对数据结构对处理。例如对数组进行操作，它们往往都局限在很小都范围内。

总的来说，局部性原理表现为时间和空间都局限性。

1. 时间局限性。如果程序中都某条指令一旦执行，则不久后该指令可能再次执行。如果某个数据结构被访问，不久以后该数据结构可能被再次访问。

2. 空间局限性。一旦程序访问了某个但愿，在不久以后，其附近的存储但愿也将被访问。

具有良好局部性的程序会经常访问相同的数据集合或相邻的数据集合。

具有良好局部性的程序比局部性差的程序能更好地利用处于高层次的存储器，因此运行速度更快。


## 程序的链接和接入
高级语言程序必须经过编译、链接才能成为可执行程序，操作系统需要为程序的执行分配内存空间。

下面介绍链接程序的功能和程序被装入内存的几种方式。

一、程序的链接
链接程序不属于操作系统的构成部分，但是它为操作系统提供可装入的程序模块。

链接 程序要解决的问题是将编译后的目标模块装配成一个可执行的程序。根据程序进行的时间和实现方式的不同，可以把链接分为静态链接和动态链接。

1. 静态链接
静态链接（static linking）是在程序运行前，用链接程序将目标模块链接成一个完整的装入模卡。静态链接程序的任务一是对逻辑地址进行修改，二是变换外部调用符号。

1) 对逻辑地址进行修改

2) 变换外部调用符号

静态链接相对于动态链接而言，程序运行速度较快。但是无论程序在本次运行中会不会被执行，都将全部被链接到一个可执行文件中，使可执行文件比较大，占用的内、外存空间较大，使存储开销较大。
另外，使用静态链接的方式，程序开发不够灵活、方便，修改某一个模块会导致整个程序的重新链接。


2. 动态链接
采用动态链接（Run-time Dynamic Linking）,可将某些目标模块的链接推迟到这些模块中的函数被调用执行时才进行。即在程序执行时，若发现一个被调用模块尚未链接，再把它链接到调用者模块上。采用动态链接的优点是节省内存和外存空间，方便了程序开发。
例如开发一个图形控件，若让图形控件以动态链接库的形式存在，整个控件就可以独立开发，独立编译和链接。但由于动态链接是在程序运行过程中从外存将被调用的模块调入内存并链接到调用者模块上，这需要运行时的时间开销，会使程序运行时的速度变慢。

二、 程序的装入

在多道程序环境下，程序要运行必须为之创建进程，而创建进程后，不可避免地要为进程分配内存，并将进程的程序和数据装入内存。将一个用户的源程序变为一个可在内存中执行的程序，通常要经过编译、链接和装入3个阶段。

通常，可执行程序以二进制可执行文件的形式存储在磁盘上，为执行程序，操作系统需要把程序调入内存。

多数系统允许操作系统将用户进程放在物理内存的任意位置。因此，虽然计算机的地址空间从0开始，但用户进程的起始地址不一定是0。在绝大多数情况下，源程序需要经过编译、链接和装入几个阶段才能执行。在不同阶段，程序地址有不同的表示形式。源程序中的地址通常是符号表示，如一个模型变量counter。编译器将这些符号地址变为可重定位地址，通常是相对于本模块开始位置的地址。例如，被编译模块的起始地址为0，所有符号地址都转变成相对于0开始的一个逻辑地址。每一次的地址变化都是从一个地址空间到另一个地址空间的映射。根据形成在内存中物理地址的时机不同，把程序的装入方式分为绝对装入方式、可重定位装入方式（静态重定位）和动态运行时装入方式。

1. 绝对装入方式

2. 可重定位装入方式（静态重定位）

3. 动态运行时装入（动态重定位）

## 连续分配存储管理方式
连续分配是指操作系统分配内存时，为每个进程分配一块物理地址连续的内存空间。连续分配方式有3种类型。

1. 单一连续区分配方式
内存中只有一个用户区，任意时刻内存种只能装入一道程序，这种分配方式仅适用于单用户、单任务的系统。

2. 固定分区分配方式
将内存用户区划分成若干个固定大小的区域，每个区域中驻留一道程序。

3. 动态分区分配方式
系统动态地对内存进行划分，根据进程需要的空间大小分配内存。内存中分区的大小和数量是变化的。动态分区方式比固定分区方式显著地提高了内存利用率。


一、单一连续分配

二、固定分区分配

三、动态分区分配

## 基本分页存储管理方式

一、分页存储管理的基本原理

1. 基本概念

2. 基本分页存储管理方式中的地址结构

3. 分页地址更换

4. 页大小的选择

二、快表

1. 什么是快表

2. 引入TLB之后的地址变换过程

3. 引入TLB的性能分析

三、两级和多级页表

1. 两级页表

2. 多级页表结构

四、反置页表

1. 反置页表

2. 反置页表的地址映射

五、 空闲页框的管理

1. 使用位图管理空闲页框

2. 使用空闲页框的链表

## 基于分页的虚拟存储系统

一、请求分页中的硬件支持

1. 页表

2. 缺页异常机构

3. 地址变换

二、页分配策略

1. 最少页框数

2. 页分配和置换策略

3. 分配算法

三、页调入策略

1. 何时调入页

2. 从何处调入页

3. 页调入过程

四、页置换算法

1. 最佳置换算法和先进先出置换算法

2. 最近最久未使用LRU置换算法

3. 其他置换算法

五、请求分页系统的性能分析

1. 缺页率对有效访问时间对影响

2. 工作集

3. 抖动产生对原因和预防方法

## 分段存储管理

## Linux的伙伴系统
因为在操作系统中，经常会遇到要为进程分配连续物理内存块的情况，典型的如在Linux中创建新进程时，需要为进程分配连续的8kb空间，即两个连续的页框用于存放task_struc结构和进程的内核推栈。因此，内核应该为分配一组连续的页框而建立一种稳定、高效的分配策略。

Linux的伙伴系统算法把所有的空闲页框分组为11个块链表，每个块链表分别包含大小为1、2、4、8、16、32、64、128、256、512和1024个连续的页框。对1024个页框的最大请求对应着4MB大小的连续页框。每个块的第一个页框的物理地址是该块大小的整数倍。例如大小为16个页框的块，其起始地址为16*12的倍数。

