# 文件系统

文件系统为用户提供了在计算机系统中对数据信息进行长期、大量存储和访问对功能。

## 文件

### 文件命名

所有操作系统都允许用1-8个字母组成的字符串作为文件名。
多数操作系统都支持文件名用圆点隔开氛围两部分，圆点后面的部分分为文件扩展名。

### 文件结构

1. 无结构字节序列

无结构字节序列也称为流式文件. 操作系统不知道也不关心文件内容是什么，操作系统所见到的就是字节。

2. 固定长度记录序列

构成文件的基本单位是具有固定长度的记录，每个记录都有其内部结构。把文件作为记录序列的中心思想是：读操作返回一个记录，而写操作重新或者追加一个记录。


3. 树形结构

文件由一棵记录树构成，记录长度不定，在记录的固定位置包含一个关键字域.记录树按关键字域排序。

### 文件类型

文件的类型有正规文件、目录文件、字符设备文件和块设备文件等。

正规文件包含用户信息，一般分为ASCII文件和二进制文件。

目录文件用于管理文件的系统文件。

字符设备文件和输入输出有关，用于串行I/O类设备。

1. ASCII （Amercian Standard Code for Information Interchange）文件

ASCII文件由多行正文组成, 在某些系统中每行用回车符结束， 某些则用换行符结束，而有些系统还同时采用回车符和换行符。
ASCII文件的明显优势是可以显示和打印，也可以用通常的文本编辑器进行编辑。

2. 二进制文件

具有一定的内部结构，如可执行的.exe 文件。 必须用专门的二进制文件编辑器，不同的操作系统可以识别不同的二进制文件。

### 文件存取

用户通过对文件对存取来完成对文件对各种操作，文件对存取方式是由文件对性质和用户使用文件对情况确定的。常用的文件存取方式由两种，顺序存取和随机存取。

1. 顺序存取

早起的操作系统只有顺序存取这一种文件存取方式。进程可以从文件开始处读取文件中的所有字节或记录，但不能跳过某些内容，也不能不按顺序存取。

2. 随机存取

随机存取又称直接存取，即可以以任意顺序读取文件中但字节或者记录。现代操作系统的文件一旦被创建，所有文件自动成为随机存取文件。定长记录的文件能很好地支持随机存取，而变长记录虽然可以随机存取，但实现起来复杂而且存取速度慢。


### 文件属性

为方便管理，除了文件名和文件数据外，文件系统还会保存其他与文件相关的信息，如文件的创建日期，文件大小和修改时间等，这些附加信息成为文件属性。

文件属性在不同操作系统中差别很大。

### 文件操作

使用文件等目的是存储信息并方便以后检索。 不同的系统提供了不同的操作来存储和检索信息。

1. CREATE 

该操作完成创建文件的功能，并设置文件的一些属性。

2. DELETE

当不再需要某个文件时，删除该文件并释放磁盘空间。

3. OPEN

在使用文件之前，必须先打开文件。 OPEN 调用的目的是将文件属性和文件的地址信息装入主存，便于在对文件的后续访问中能快速存取文件信息。

4. CLOSE

当存取结束后，不再需要文件属性和地址信息，这时应该关闭文件以释放内部表空间。很多系统限制进程打开文件的个数，以鼓励用户关闭不再使用的文件。

5. READ

从文件中读取数据。 一般地，用户可以指定从哪个文件的第几个字节开始读取多少个字节的内容。

6. WRITE

从文件中写数据，写操作一般从写函数的参数指定的文件位置开始。如果当前位置是文件末尾，文件长度增加。如果当前位置在文件中间，则现有数据被覆盖，并且永远丢失。

7. APPEND

该操作是WRITE调用的限制形式，它只能在文件末尾添加数据。

8. SEEK

对于随机存取文件，要指定从何处开始取数据。 通常的做法是用 SEEK 系统调用把当前位置指针指向文件中特定的位置。SEEK调用结束后，就可以从该位置读写数据了。

9. GETATTRIBUTES

该操作用于获取文件属性。

10. SETATTRIBUTES

某些属性是可由用户设置的，文件创建以后，用户还可以通过系统调用SETATTRIBUTES 来修改它们。

11. RENAME

该操作用于修改已有文件的文件名。


## 目录

文件系统通常提供目录或文件夹用于记录文件，很多系统中目录本身也是文件，目录是文件系统中实现按名访问文件的重要数据结构。

### 层次目录系统

1. 目录文件的结构

目录文件由两种常见的结构：属性放在目录项中和放在i结点中。
文件目录包含许多目录项，每个目录项用于描述一个文件。

在第一种结构中，每个目录项长度相同，每个文件对应一个目录项。 其中包含文件名、文件属性和文件的地址。

在第二种结构中，目录项中有一个文件名和i结点号。 i结点是一种数据结构，文件属性和文件的地址信息存放在i结点中。


2. 目录结构

文件目录的组织和管理是文件管理的一个重要方面，包括单层目录，两级目录和树形目录。

(1) 单层目录

这种目录也被称为根目录。在整个系统中设置一张线性目录表，表中包括了所有文件的描述信息。

使用单层目录时，要查找一个文件必须对单层目录表中的所有文件信息项进行搜索，因而搜索效率也较低。

(2) 两级目录

为了避免文件名冲突，一种改进的方法是为每个用户提供一个私有目录。这样，一个用户选择文件名时就不会影响到其他用户。

使用两级目录的优点是解决来文件的重名问题和文件共享问题，查找时间降低。缺点是增加了系统的存储开销。

(3) 树形目录

把两级目录的层次关系加以推广，就形成了多级目录，又称树形目录。

树形目录的优点是便于文件的分类，层次结构清晰，便于管理和保护，解决了重名问题问题，查找速度加快。

缺点是查找一个文件按路径名逐层检查，由于每个文件都放在外存中，多次访问磁盘会影响速度，结构相对复杂。


### 路径名

用目录树组织文件系统时，需要有某种方法指明文件名。常用的方法有两种：绝对路径名和相对路径名。

1. 绝对路径名

绝对路径名由从根目录到文件的路径组成。

2. 相对路径名

当访问一个文件系统的目录包含很多级时，如果访问每个文件都要从根目录开始，直到叶子的文件名为止，包含所有经过的各级分目录在内的全路径名是相当麻烦的。

在设计文件系统时，可以允许用户指定一个目录作为当前的工作目录，所有的不从根目录开始的路径名都是相对于工作目录的。

### 目录操作

1. CREATE

根据给定的目录文件名，创建目录。 除了目录项 " . " 和 " .. " 外，目录内容为空。 

2. DELETE

删除目录，根据指定的目录名删除一个目录文件。

3. OPENDIR

目录内容可以被读取

4. CLOSEDIR

读目录结束后，应关闭目录以释放内存表空间。

5. READDIR

以标准格式返回打开目录的下一步目录项。

6. RENAME

更换目录名

## 文件系统的实现

### 实现文件

1. 连续分配

顾名思义，连续分配就是把每个文件作为一连串连续数据块存储在磁盘上。

连续分配方式有两大优点： 首先，实现简单，记录每个文件用到的簇仅需存储两个数字即可：第一块的磁盘空间和文件的块数。给定第一块的簇号，就可以找到任何其他块的簇号。其次，读操作性能好，在单个操作中就能从磁盘上读取整个文件。只需要寻找一次第一个块，之后不再需要寻道和旋转延迟，所以数据以磁盘全带宽的速率输入。

2. 使用磁盘链接表的分配

该方法为每个文件构造簇的链接表，每个簇开始的几个字节用于存放下一个簇的簇号，簇的其他部分存放数据，每个文件可以存放在不连续的簇中，在目录项中只需存放第一个数据块的磁盘地址，文件的其他块可以根据这个地址来查找。

3. 使用内存的链接表分配

该方法是将文件所在的磁盘的簇号存放在内存的表中。访问文件时，只需从内存文件分配表中顺着某种链接关系查找簇号，不管文件有多大，在目录项中只需记录文件的第一块数据所在簇的簇号，根据它查找到文件的所有块。

4. i结点

该方法为每个文件赋予一个被称为i结点的数据结构。

### 实现目录

系统在读文件前，必须先打开文件。打开文件时，操作系统利用用户给出的路径名找到相应的目录项，目录项中提供来查找文件簇所需要的信息。

1. CP/M 中的目录

CP/M是一个微机操作系统，它只有一层目录，因此只有一个目录文件。 要查找文件名，就是在这个唯一的目录文件中找到文件对应的目录项，从目录项中获得文件存放的磁盘地址。

2. MS-DOS 中的目录

MS-DOS 文件系统曾经是IBM PC系列所采用的文件系统，目前它已经不再是新的PC文件系统的标准来，但它和它的扩展（FAT32）一直被许多嵌入式系统所广泛使用。大部分的数码相机，MP3使用了它，

3. UNIX 中的目录

每个目录项只包含一个文件名及其i结点号。 有关文件类型、长度、时间、所有者和簇号等信息都放在i结点中。
当打开某个文件时，文件系统必须要获得文件名并且定位文件所在的第一个簇。


### 磁盘空间管理

磁盘空间管理是文件系统的重要功能，包括记录空闲磁盘信息、设计文件的存放方式，以及规定文件系统的簇大小等内容。

1. 簇大小

文件系统为文件分配磁盘空间是以簇为单位的，一旦用固定大小的簇来存储文件，就会出现一个问题：簇的大小应该是多少？

拥有大的簇尺寸意味着每个文件，甚至一个字节的文件，都要占用很大的空间，也就是说小的文件浪费了大量的磁盘空间。另一方面，小的尺寸意味着大多数文件会跨越多个簇，因此需要多次寻道与旋转延迟才能读出它们，从而降低来时间性能。因此，簇太大，容易造成空间的浪费；簇太小，则会使访问文件的时间延长。

2. 记录空闲块

(1)空闲簇链接表

用一些空间簇存放空闲簇的簇号。一个簇存放尽可能多的空闲簇的簇号，并专门留出最后几个字节存放指向下一个存放空闲簇的指针，

(2)

用n位图对应磁盘的n个簇，在位图中，空闲簇用1表示，已分配簇用0表示（或者反过来）


# I/O 设备管理

计算机系统中的I/O设备即输入/输出设备是用于计算机系统与人通信或与其他机器通信的所有设备，以及所有外存设备。

## I/O系统的组成

I/O设备要通过总线与CPU、内存相连。

### I/O系统的结构

I/O 系统的结构分为微机I/O系统  和 主机I/O系统两大类

1. 微机I/O系统

总线型I/O系统结构，CPU与内存之间可以直接进行信息交换，但是不能与设备直接进行信息交换，必须经过设备控制器。

2. 主机I/O系统

I/O 系统可能采用四级结构，包括主机、通道、控制器和设备。 一个通道可以控制多个设备控制器，一个设备控制器也可以控制多个设备。

### I/O设备的分类

不同功能的I/O设备种类繁多，可以根据设备的某种特点或功能对设备进行分类。

1. 按传输速率分类

1) 低速设备。 如键盘和鼠标，传输速率为几百个字节/秒
 
2) 中速设备。如打印机，传输速率为数千个到数万个字节/秒

3) 高速设备。 如磁带机、磁盘机、光盘机，速率为几十万到几兆字节/秒

2. 按信息交换的单位分类

1) 块设备。 数据的存取以数据块为单位，如磁盘。块设备在块中保存信息，块的大小通常是固定的，并且一次只能传送一块。

2) 字符设备。 传送字节流，没有使用块结构。终端、打印机、通信端口和鼠标等都是字符设备。

在操作系统实现驱动程序时，通常需要区分一个设备是块设备还是字符设备，操作系统对这两种设备的缓冲管理和驱动程序的实现方式是不同的。


3. 按设备的共享属性分类

1) 独占设备。 是必须作为临界资源以互斥方式访问的设备。在一个进程没有使用完毕之前，其他任何进程不能访问该设备，知道设备被释放。

2) 共享设备。 是允许多个进程共同访问的设备，如硬磁盘是典型的共享设备

3) 虚拟设备。 是通过某种虚拟技术把一台物理设备变成若干逻辑设备，从用户的角度看，多个用户拥有各自的设备，可以随时向设备发出访问请求并得到系统应答。


### 设备控制器

I/O 设备分为机械和电子两部分，设备控制器对应电子部分，通常是可变成的。操作系统的程序员需要了解的是设备控制器的结构、编写设备驱动程序要针对具体的设备控制器，了解设备控制器中寄存器、端口的名称、地址和访问方式，以及使用方式。

1. 什么是设备控制器

1) 设备控制器是CPU与I/O设备之间的接口，接收I/O的命令并控制设备完成I/O工作。

2) 设备控制器是一个可编址设备，连接多个设备时可有多个设备地址。控制器可以直接做在主板上，也可以做成插卡插在主板上。现在有些设备的控制器潜入在设备中，如激光打印机的控制器。

2. 设备控制器的功能

1) 接收和识别命令

接收CPU的命令和参数存放在控制器的控制寄存器中，并对命令和地址译码

2) 数据交换

(1) 将驱动器中的比特流汇集在控制器的缓冲区中以形成字节块。

(2) 实现CPU到控制器、控制器到CPU的双向数据传送。

(3) 将控制器对设备的控制命令传送给设备控制器。

3) 设备状态的了解和报告

设备控制器中有专门用来存放设备状态信息的寄存器或触发器，CPU可以通过读取这些信息了解设备的当前状态。

4) 地址识别

(1) 设备控制器必须能识别它所控制的每个设备的地址。
 
(2) 设备控制器中的寄存器本身应该有唯一的地址，以使CPU能向寄存器中读/写数据。

(3) 将CPU要访问的外设地址送入控制器，由控制器的地址译码器译码后选中目标设备。

5) 数据缓冲

在设备控制器中可以存储数据，作为CPU和I/O之间的缓冲。

6) 差错控制

设备控制器需要具有差错检测功能，当通过数据校验发现数据传输出错时，可以向CPU报告，废弃错误数据，重新启动一次数据传输。

3. 设备控制器的组成

设备控制器的逻辑构成主要包括以下三部分

(1) 设备控制器与处理机的接口：数据线、控制线和地址线。

(2) 设备控制器与设备的接口：设备与设备控制器接口中的3类信号为数据、状态和控制信号。

(3) I/O 逻辑：I/O逻辑主要由指令译码器和地址译码器两部分功能部件构成，将CPU的命令和地址分别译码，控制指定设备进行I/O操作。



### I/O通道

通道用于大型主机系统控制I/O设备，与控制设备结合，与微机与小型机的设备控制器具有对等的功能。

即用来代替微机、小型机中的设备控制器，实现大型主机系统的I/O设备控制功能，提供操作系统与I/O设备间的接口。

## I/O控制方式

输入/输出方式有早期的程序轮询控制方式。

在中断机制被引入计算机系统后，输入/输出控制采用中断控制方式。 为了提高块设备的输入/输出性能，可以利用DMA直接访问内存，控制器对输入/输出进行DMA控制。

通道控制方式则可以使输入/输出更大程序地独立于主机CPU。

在输入/输出控制方式的发展中始终追求的目标是尽量减少主机对输入/输出控制的干预，提高主机与输入/输出的并行程度，以提高整个系统的性能。


### 轮询

早期的计算机系统，以为没有中断机制，处理器对输入/输出的控制不得不采取程序轮询的方式。

采用这种控制方式，主机试图发送I/O控制命令之前，先通过反复检测设备控制器状态寄存器的忙/闲标志位，若设备“忙”，主机继续检测该标志位，直到该标志位为“空闲”，主机发送I/O指令。 在主机发送完I/O指令后，设备控制器把状态寄存器的忙/闲标志位再置为“忙”，主机再次进入轮询状态，以检测本次输入/输出是否结束。

这种控制方式使CPU经常处于由于输入/输出而造成的循环测试状态，造成CPU的极大浪费，影响整个系统的吞吐量。




### 中断

现代计算机系统广泛采用中断控制方式完成对I/O的控制。采用中断控制方式的I/O工作模式是CPU执行进程中，发出输入/输出请求，若此时I/O设备忙，则进程阻塞等待。当处于“忙”状态的设备工作完毕，通过中断控制器发出中断请求信号，CPU响应中断，执行对应该设备的中断处理程序，然后唤醒因等待该设备而被阻塞的进程。CPU继续执行这个进程时，向设备控制器发送I/O指令，然后CPU被调度程序分配给某个进程，继续执行某个程序。自此，在设备控制器控制设备完成本次I/O的过程中，I/O与CPU并行工作。当本次I/O结束后，设备控制器通过向CPU发送中断请求信号告知CPU本次数据传输结束。中断控制的工作方式能使CPU与I/O设备在某些时间段上并行工作，提高CPU的利用率和系统的吞吐量。


### DMA控制方式

对于磁盘驱动器这类的设备，每次数据传输量较大，采用中断控制方式，传输一个数据块就需要进行多次中断处理。

DMA 控制需要特殊结构的设备控制器，DMA控制器的逻辑组成包括3部分：主机与DMA的接口、DMA与设备的接口，以及I/O控制逻辑。

1. 命令/状态寄存器CR

用于接收从CPU发来的I/O命令或有关控制信息、设备状态。

2. 内存地址寄存器MAR

存放内存地址，在输出数据时，存放输出数据在内存的起始地址，指示DMA应该从内存的什么地方读取输出数据。在输入数据时，存放输入数据将要被放入内存的起始地址，指示DMA应该把输入数据放到内存的什么地方。

3. 数据计数器DC

指示DMA，本次向CPU发出中断信号前要读或写数据的次数。

4. 数据寄存器DR

用于暂存DMA传输中要输入或输出的数据。

DMA工作原理以及DMA控制和中断控制的区别

1. 没有使用DMA时磁盘读数据的过程。

(1) 首先控制器一个比特一个比特地从设备完整地读出一块数据放入内部缓冲区中。

(2) 确认该块数据的正确性。

(3) 控制器发中断信号，CPU执行中断处理程序，从控制器的设备寄存器中将数据读入内存。

2. 通过DMA从磁盘读数据的过程。

当CPU要从磁盘读入一个数据块时，便向磁盘控制器发出一条读命令。该命令被送到其中的命令寄存器CR中。

同时，CPU将本次读入数据将要放在内存中的起始地址送DMA的MAR寄存器，将本次要读的字节数送DC寄存器。

然后，启动DMA控制器进行数据传送。

在DMA控制输入的过程中，CPU可以执行其他的进程。

当本次读入的数据全部输入完毕，DMA向CPU发送中断请求。


## 缓冲管理

缓冲区是用来保存两个设备之间或设备与应用程序之间传输数据的内存区域。由于CPU的速度远高于I/O设备，为了尽可能使CPU与设备进行工作，提高系统的性能，通常需要操作系统在设备管理软件中提供缓冲区管理功能。

### 缓冲的引入

在数据到达速率与数据离去速率不同的地方，都可以引入缓冲区。

引入缓冲区的主要原因可以归纳为以下两点。

(1) 处理数据流的生产者与消费者之间的速率差异。

(2) 协调传输数据大小不一致的设备

引入缓冲区除了可以缓冲和CPU与I/O设备之间速度不匹配的矛盾，还能降低对CPU中断频率的要求，放宽对中断响应时间的限制，提高CPU和I/O设备之间的并行性。

### 单缓冲

操作系统提供的最简单的缓冲类型是单缓冲区，当一个用户进程发出I/O请求时，操作系统为该操作分配一个位于主存的缓冲区。

### 双缓冲

可以通过给操作系统指定两个系统缓冲区，当一个进程往这一个缓冲区中传送数据，或从这个缓冲区中读取数据时，操作系统正在清空或填充另一个缓冲区，这种技术被称为双缓冲，或缓冲交换。

双缓冲的性能比单缓冲的性能有所提高，但是这种提高是以增加复杂性为代价的。

### 循环缓冲

1. 循环缓冲的组成

(1) 多个缓冲区

1) 空缓冲区

2) 已装满数据的缓冲区

3) 现行工作缓冲区


(2)

1) Nextg: 用于指示消费者进程下一个可用的装有数据的缓冲区。

2) Nexti: 用于指示生产者进程下一个可用的空缓冲区。

3) Current: 用于指示进程正在使用的工作缓冲区。

2. 循环缓冲的使用

(1) Getbuf 进程

消费者进程要使用缓冲区中的数据时，可调用Getbuf进程。 该进程将Nextg 指向的缓冲区提供给进程使用，并把它改成由Current指针指向的现行工作缓冲区，同时使Nextg指向下一个可用的装有数据的缓冲区G。而当生产者进程要使用空缓冲区来装数据时，也通过调用Getbuf过程，把Nexti指示的空缓冲区提供给生产者进程使用，然后使Nexti指向下一个空缓冲区R。

(2) Releasebuf 过程

当进程使用完缓冲区之后，调用Releasebuf过程释放缓冲区。当消费者进程把C缓冲区中的数据提取完毕时，便调用Releasebuf过程释放C缓冲区，把该缓冲区改为空缓冲区R。

当生产者进程把缓冲区装满数据后，调用Releasebuf过程释放缓冲区，使装满数据的当前工作缓冲区成为G缓冲区。

3. 进程同步

由于使用缓冲可使生产者进程和消费者进程并行执行，相应地，指针Nexti和指针Nextg将不断地沿顺时针方向移动，在下列两种情况下需要保持两种进程同步的机制。

1) Nexti 指针追上Nextg 指针，即生产者进程速度大于消费者进程速度，没有空缓冲区，全部缓冲区已满。此时，需要阻塞生产者进程，等待消费者进程为生产者进程释放空缓冲区。

2) Nexti 指针追上Nexti指针，消费者进程速度大于生产者进程速度，全部缓冲已空。此时，需要阻塞消费者进程，等待生产者进程为消费者进程释放装有数据的缓冲区。

### 缓冲池

公共缓冲池是被广泛应用的一种缓冲管理技术，公共缓冲池中设置多个可供若干进程共享的缓冲区，这种方式能提高缓冲区的利用率。

1. 缓冲池的组成

公共缓冲池既可用于输入，又可用于输出，其中至少包含3种累心的缓冲区、3种缓冲队列和4种工作缓冲区。

1) 3种类型的缓冲区。 空缓冲区、装满输入数据的缓冲区和装满输出数据的缓冲区。

2) 3种队列

(1) 空缓冲队列emq：是由空缓冲区链接而成的队列。

(2) 输入队列inq：是由装满输入数据的缓冲区链接成的队列。

(3) 输出队列outq：是由装满输出数据的缓冲区链接成的队列。

3) 4种工作缓冲区

(1) 收容输入数据的缓冲区。

(2) 提取输入数据的缓冲区。

(3) 收容输出数据的缓冲区。

(4) 提取输出数据的缓冲区。

2. Getbuf过程和Putbuf过程

对缓冲池的操作由Getbuf过程和Putbuf过程来完成。为了使进程能以互斥的方式访问缓冲池队列，可为每个队列设置一个相应的互斥信号量MS(type) ，为了保证进程同步使用缓冲区，可以为每个队列设置一个资源信号量RS(type)。其中type指示缓冲区队列类型，可以是emq，inq或outq

3. 缓冲区的工作方式

缓冲区可以工作在收容输入、提取输入、收容输出和提取输出4种工作方式下。

(1) 收容输入
在进程需要收容输入数据时，需要从空缓冲队列提取一个空缓冲区，将输入数据写入缓冲后，再把装入了输入数据的缓冲区插入到输入队列中去

(2) 提取输入
当进程需要输入数据时（如计算进程需要提供输入数据，然后对数据进行计算处理），先从输入队列提取输入缓冲区，然后从中提取输入数据，最后把缓冲区作为空缓冲区插入空缓冲队列。

(3) 收容输出
在进程需要收容输出数据时，要先从空缓冲队列提取一个空缓冲区，将输出数据写入缓冲后，再把装入了输出数据的缓冲区插入到输出队列中去。

(4) 提取输出
当进程需要输出数据时（如打印进程需要提取输出数据送打印机），先从输出队列提取输出缓冲区，然后从中提取输出数据，最后把这个缓冲区插入空缓冲队列。

## 设备分配

在多道程序环境下，系统中的设备不允许用户自行使用，而必须由系统分配。每当进程向系统提出I/O请求时，设备分配程序便按照一定的策略，把设备分配给用户。设备分配功能的完成，需要记录设备情况的数据结构和设备分配算法。

### 设备分配中的数据结构

1. 设备控制表DTC(device Control Table)
系统为每个设备建立一张设备控制表，多台设备的设备控制表构成设备控制表集合。每张设备控制表包含以下信息：
1) 设备类型
2) 设备标志符
3) 设备状态 （忙/闲）
4) 指向控制器表的指针
5) 重复执行的次数或时间
6) 设备队列的队首指针。 设备队列也成了设备请求队列，是因请求设备而被阻塞的进程的PCB构成的队列。设备队列的队首指针指向队首的PCB。

2. 控制器控制表COCT (Controller Control Table)

系统为每个控制器设置一张用于记录该控制器信息的控制器控制表，控制器控制表中通常包含以下几个字段。

1) 控制器标识符
2) 控制器状态
3) 与控制器相连接的通道表指针
4) 控制器队列的队首指针
5) 控制器队列的队尾指针

3. 通道控制器 CHCT (Channel Control Table)

在一些主机系统中还有通道设备，系统会为每个通道设备设置一张通道控制表，通道控制表包括以下几个字短。

1) 通道标识符
2) 通道状态
3) 与通道链接的控制器表首址
4) 通道队列的队首指针
5) 通道队列的队尾指针

4. 系统设备表 SDT(System Device Table)

系统设备表是系统范围的数据结构，其中记录了系统中全部设备的情况。每个设备占一个表目，其中包括设备类型、设备标识符、设备控制表及设备驱动程序的入口地址。

### 设备分配

为了使系统有条不紊的工作

1. 设备的固有属性

在分配设备时，首先应考虑与设备分配有关的设备属性，设备的固有属性可分为3种：

1) 独占性，指这种设备在一段时间内只允许一个进程独占，即 "临界资源"
2) 共享性，这种设备允许多个进程同时共享。
3) 虚拟性，指设备本身是独占设备，但经过某种技术处理后，可以把它改造为虚拟设备。

2. 设备分配算法

对设备分配但算法，与进程调度的算法有相似之处，但相对简单，通常只采用以下两种

1) 先来先服务

当有多个进程对同以设备提出I/O请求时，该算法是根据进程对某设备提出请求后对先后顺序将这些进程排成一个设备请求队列，设备分配程序总是先把设备分配给队首进程。

2) 基于优先权对分配算法

在进程调度中的这种策略，是优先权搞的进程优先获得处理机。如果对这种高优先权进程所提出的I/O请求也赋予高优先权，显然有助于这种进程尽快完成。再利用该算法形成设备队列时，将优先权高的进程排在设备队列前面，面对于优先级相同的I/O请求，则按先来先服务原则排队。

3. 设备分配方式

从安全性上考虑

1) 安全分配方式

2) 不安全分配方式

### 设备独立性

1. 设备独立性的概念

为了提高操作系统的可适应性和可扩展性，在现代操作系统中都毫无例外地实现了设备独立性，也称为设备无关性。其基本含义是应用程序独立于具体使用的物理设备。为了实现设备独立性，引入了逻辑设备和物理设备这两个概念。

2. 实现设备独立性带来的好处

1) 应用程序与物理设备无关，系统增减或变更外围设备时不需要修改应用程序。

2) 易于处理输入/输出设备的故障。

3) 提高了系统的可靠性，增加了设备分配的灵活性。

3. 设备独立软件

1) 执行所有设备的公有操作

2) 向用户层软件提供统一的接口


### 独占设备的分配程序

对于具有I/O通道的系统，在进程提出I/O请求后，系统的设备分配程序可按下来操作进行设备分配

1. 分配设备

根据用于请求的设备的物理名，查找系统设备表，从中找出该设备的设备控制表，检查设备控制表中的设备状态字。

2. 分配控制器

若系统为进程分配了其请求的设备，就到该设备的控制表中找出与该设备链接的控制器的COCT，即设备控制器控制表，检查其中的状态字段。若该控制器忙，则将请求I/O的进程阻塞在该设备控制器的阻塞队列中；若空闲，则分配给进程。

3. 分配通道

在有通道的系统中，还需要从相应的设备控制器控制表中找到与该控制器链接的通道控制表，检查表中的通道状态字段。若通道忙，则将进程阻塞在该通道的阻塞队列上；若通道空闲，则将该通道分配给进程。

当进程获得了设备、设备控制器或者获得了设备、设备控制器和通道时，系统的本次设备分配才算成功，系统可以启动进程的I/O

### SPOOLing 技术

在多道程序环境下，利用一道程序来模拟脱机输入时的外围控制器的功能，把低速I/O设备上帝数据传送到高速输出磁盘上，再利用另一道程序来模拟脱机输出时外围控制机的功能，把数据从磁盘传送到低速输出设备上。这种在联机情况下实现的同时外围操作成为SPOOLing，(Simulataneous Perihernal Operations On-Line)

1.  SPOOLing 系统组成

1)输入井和输出井

2)输入缓冲区和输出缓冲区。

3)输入进程SP和输出进程SP

4)请求I/O队列。 请求输入或输出的进程提交的输入/输出任务组成的队列。

2. 利用SPOOLing 技术实现共享打印机

当用户进程提出打印请求时，SPOOLing 系统先为用户做下列两件事。

1) 由输出进程在输出井中申请空闲盘块区，并将要打印的数据送入其中。

2) 输出进程再为用户申请并填写一张用户请求打印表，将该表挂到请求打印队列上。当打印机空闲时，输出进程完成以下动作。
(1) 从请求打印队列队首取一张请求打印表

(2) 将打印数据从输出井送到打印机缓冲区

(3) 打印

(4) 打印完毕，若打印队列不为空，则转第一步。

SPOOLing 系统的特点如下。

1) 提高了I/O速度。 由于使用来磁盘作为低速设备的大容量缓存，提高了输入/输出的速度。

2) 将独占设备改造为共享设备。 通过SPOOLing 系统使独占设备变为了逻辑上的共享设备，系统可以同时接受多个用户对设备对访问请求。

3) 实现了虚拟设备功能。 把一台物理上只能互斥使用的设备，变为来从用户眼里看到的共享设备。 

宏观上看，系统可以同时响应多个用户对设备的请求。 
微观上看，任意时刻设备只能为某一个用户进程服务，SPOOLing系统实现了将独占设备变换成多个逻辑设备的功能。


## I/O软件原理

### 设备管理软件的功能

1. 

2.  

3. 

4. 

5. 

6. 



### 中断处理程序



### 设备驱动程序

### 与硬件无关的I/O软件




## 磁盘管理


### 磁盘结构

1. 

2. 

3. 

### 磁盘调度

1. 

2. 

3. 

4. 

5. 



### 提高磁盘I/O速度的方法

1. 

2.  

3. 

4. 

5. 

